---
phase: "02-formatter-tests"
plan: "01"
type: "execute"
wave: 1
depends_on: []
files_modified: ["src/output/artisan.rs"]
autonomous: true
must_haves:
  truths:
    - "TEST-07: ArtisanFormatter produces correctly formatted READ response CSV (ET,BT,Power,Fan)"
    - "TEST-08: ArtisanFormatter produces correctly formatted Artisan CSV line (time,ET,BT,ROR,Gas)"
    - "TEST-09: MutableArtisanFormatter correctly calculates ROR from BT history"
    - "TEST-10: Time values formatted as X.XX seconds (two decimal places)"
  artifacts:
    - path: "src/output/artisan.rs"
      provides: "Formatter tests module with #[cfg(test)]"
      min_lines: 50
  key_links:
    - "format_time(elapsed_secs, elapsed_ms) -> \"X.XX\" string (TEST-10)"
    - "compute_ror_from_history(history[5]) -> calculated ROR value (TEST-09)"
    - "format_read_response(status, fan_speed) -> CSV string (TEST-07)"
---

<objective>
Create comprehensive unit tests for ArtisanFormatter and MutableArtisanFormatter to verify ARTISAN+ protocol output compliance.

**Phase Goal:** ArtisanFormatter and MutableArtisanFormatter produce correctly formatted output matching ARTISAN+ protocol specification

**Purpose:** Ensure all formatter outputs are correct before integration testing, preventing downstream protocol errors
</objective>

<execution_context>
@/home/juan/.config/opencode/get-shit-done/workflows/execute-plan.md
@/home/juan/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@/home/juan/Repos/LibreRoaster/src/output/artisan.rs
@/home/juan/Repos/LibreRoaster/src/config/constants.rs
@/home/juan/Repos/LibreRoaster/src/control/abstractions_tests.rs
</context>

<tasks>

<task type="auto">
  <name>Create test SystemStatus mock helper function</name>
  <files>src/output/artisan.rs</files>
  <action>
Add a `#[cfg(test)]` module at the end of artisan.rs with a helper function `fn create_test_status() -> SystemStatus` that returns a SystemStatus with known values for testing:

```rust
fn create_test_status() -> SystemStatus {
    SystemStatus {
        state: RoasterState::Roasting,
        bean_temp: 150.5,
        env_temp: 120.3,
        target_temp: 200.0,
        ssr_output: 75.0,
        fan_output: 50.0,
        pid_enabled: true,
        artisan_control: false,
        fault_condition: false,
        ssr_hardware_status: SsrHardwareStatus::Detected,
    }
}
```

This provides consistent test data for all formatter tests.
  </action>
  <verify>`cargo test --lib -- artisan 2>&1 | head -50` shows test module compilation</verify>
  <done>Test helper function exists and returns SystemStatus with predictable values</done>
</task>

<task type="auto">
  <name>Implement TEST-07: format_read_response test</name>
  <files>src/output/artisan.rs</files>
  <action>
Add test `test_format_read_response()` that:
- Creates a test SystemStatus with known values
- Calls `ArtisanFormatter::format_read_response(&status, fan_speed=25.0)`
- Asserts output matches exact format: "120.3,150.5,75.0,25.0" (ET,BT,Power,Fan)
- Tests that all four comma-separated values are correct floats

Format: `"{:.1},{:.1},{:.1},{:.1}"` for env_temp, bean_temp, ssr_output, fan_speed
  </action>
  <verify>`cargo test format_read_response` passes with assertion of exact CSV output</verify>
  <done>TEST-07: READ response format verified correct (comma-separated ET,BT,Power,Fan)</done>
</task>

<task type="auto">
  <name>Implement TEST-08: format CSV output test</name>
  <files>src/output/artisan.rs</files>
  <action>
Add test `test_format_csv_output()` that:
- Creates an ArtisanFormatter instance
- Creates a test SystemStatus
- Calls `formatter.format(&status)`
- Asserts output matches pattern: "X.XX,ET,BT,ROR,Gas" where:
  - Time is "0.00" (start with elapsed time)
  - ET = 120.3 (env_temp)
  - BT = 150.5 (bean_temp)
  - ROR = 0.0 (first call, no history)
  - Gas = 75.0 (ssr_output)
- Verifies all comma-separated fields present

Also test `format_artisan_line` directly with known values to verify field formatting.
  </action>
  <verify>`cargo test format_csv_output` passes with assertion of correct CSV line format</verify>
  <done>TEST-08: Artisan CSV output format verified (time,ET,BT,ROR,Gas structure)</done>
</task>

<task type="auto">
  <name>Implement TEST-09: ROR calculation from BT history test</name>
  <files>src/output/artisan.rs</files>
  <action>
Add test `test_ror_calculation_from_history()` that:
- Tests `compute_ror_from_history` directly with known BT values
- Case 1: Empty history -> returns 0.0
- Case 2: 2 samples with BT change of 5.0 -> ROR = 5.0
- Case 3: 5 samples with BT values [100, 102, 104, 106, 108] -> ROR = 2.0

Test formula: `(last_bt - first_bt) / (samples - 1)`

Add test `test_mutable_formatter_ror()` that:
- Creates MutableArtisanFormatter
- Calls format() multiple times with increasing bean_temp
- Verifies ROR is calculated from accumulated history (not just delta)
  </action>
  <verify>`cargo test ror_calculation` passes with assertions on ROR values</verify>
  <done>TEST-09: ROR calculation from BT history verified correct</done>
</task>

<task type="auto">
  <name>Implement TEST-10: time format X.XX seconds test</name>
  <files>src/output/artisan.rs</files>
  <action>
Add test `test_time_format_xx_xx()` that:
- Tests `format_time` function directly with various inputs
- Case 1: elapsed_secs=5, elapsed_ms=0 -> "5.00"
- Case 2: elapsed_secs=5, elapsed_ms=50 -> "5.05"
- Case 3: elapsed_secs=0, elapsed_ms=150 -> "0.15"
- Case 4: elapsed_secs=10, elapsed_ms=999 -> "10.99"

Verify formula: `format!("{}.{:02}", elapsed_secs, elapsed_ms / 10)` produces two decimal places
  </action>
  <verify>`cargo test time_format` passes with assertions on "X.XX" format</verify>
  <done>TEST-10: Time format X.XX seconds verified correct (two decimal places)</done>
</task>

</tasks>

<verification>
Run full test suite on formatter module:

```bash
cargo test --lib -- artisan
```

Expected output:
- test_format_read_response ... ok
- test_format_csv_output ... ok
- test_ror_calculation_from_history ... ok
- test_mutable_formatter_ror ... ok
- test_time_format_xx_xx ... ok

All 4 tests (TEST-07, TEST-08, TEST-09, TEST-10) must pass.
</verification>

<success_criteria>
**Phase 2 Success Criteria Met When:**

1. ✅ `cargo test --lib -- artisan` shows 4+ passing tests
2. ✅ TEST-07: ArtisanFormatter.format_read_response produces "ET,BT,Power,Fan" CSV
3. ✅ TEST-08: ArtisanFormatter.format produces "time,ET,BT,ROR,Gas" CSV line
4. ✅ TEST-09: MutableArtisanFormatter ROR calculation from BT history works correctly
5. ✅ TEST-10: All time values formatted as X.XX seconds (two decimal places)
6. ✅ Tests use mock SystemStatus with predictable values
7. ✅ Test module added to artisan.rs with `#[cfg(test)]`

**Code Quality:**
- Tests are isolated (no shared state between tests)
- Tests are deterministic (no timing dependencies)
- Tests verify exact output values, not just presence
</success_criteria>

<output>
After completion, create `.planning/phases/02-formatter-tests/02-01-SUMMARY.md`
</output>
