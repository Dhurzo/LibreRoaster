---
phase: 08-command-hardening
plan: "02"
type: execute
wave: 2
depends_on: ["01"]
files_modified:
  - src/control/handlers.rs
  - src/control/roaster_refactored.rs
  - src/output/artisan.rs
  - tests/command_idempotence.rs
autonomous: true
must_haves:
  truths:
    - "START is idempotent: repeated START keeps streaming enabled once without duplicating state"
    - "STOP is idempotent: repeated STOP halts streaming, zeros outputs/fan, and leaves state consistent"
    - "Manual OT1/IO3 updates stay within 0–100% and reset to safe values on STOP"
    - "READ responses always return ET,BT,Power,Fan with fixed precision and no extra/missing fields"
  artifacts:
    - path: src/control/handlers.rs
      provides: "Idempotent start/stop handling and bounded manual setpoints"
    - path: src/control/roaster_refactored.rs
      provides: "State/reset logic ensuring streaming flags and outputs are in sync"
    - path: src/output/artisan.rs
      provides: "Deterministic READ response formatting for required telemetry fields"
    - path: tests/command_idempotence.rs
      provides: "Tests covering start/stop idempotence, safe outputs, and READ field precision"
  key_links:
    - from: src/control/handlers.rs
      to: src/control/roaster_refactored.rs
      via: "Continuous output enable/disable and state flags"
      pattern: "enable_continuous_output|disable_continuous_output"
    - from: src/output/artisan.rs
      to: tests/command_idempotence.rs
      via: "READ response precision and field order assertions"
      pattern: "format_read_response"
    - from: tests/command_idempotence.rs
      to: src/control/handlers.rs
      via: "Repeated START/STOP scenarios and manual bounds checks"
      pattern: "StartRoast|StopRoast|SetHeaterManual|SetFanManual"
---

<objective>
Ensure core command handlers are idempotent and safe: START/STOP toggles streaming exactly once, OT1/IO3 stay within 0–100% and reset on STOP, and READ responses are deterministic in fields and precision.

Purpose: Fulfill CMD-01 through CMD-05 by guaranteeing stable command effects and predictable telemetry, preventing duplicated sessions or unsafe outputs under repeated commands.
Output: Hardened control handlers, deterministic READ formatting, and tests proving idempotence and bounds.
</objective>

<execution_context>
@/home/juan/.config/opencode/get-shit-done/workflows/execute-plan.md
@/home/juan/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/STATE.md
@.planning/ROADMAP.md
@.planning/PROJECT.md
@src/control/handlers.rs
@src/control/roaster_refactored.rs
@src/output/artisan.rs
@tests/artisan_integration_test.rs
</context>

<tasks>

<task type="auto">
  <name>Make START/STOP idempotent and safe</name>
  <files>src/control/handlers.rs, src/control/roaster_refactored.rs</files>
  <action>
    Add guards so START only enables streaming/PID once and leaves existing session intact on repeats. Ensure STOP always disables continuous output, zeros heater/fan, clears manual overrides, and returns to a consistent idle/safe state without re-triggering faults. Keep emergency stop behavior unchanged.
  </action>
  <verify>
    cargo test --test command_idempotence start_stop_idempotent
  </verify>
  <done>
    Repeated START/STOP sequences leave streaming toggled correctly, outputs safe, and status fields consistent without duplicate activation.
  </done>
</task>

<task type="auto">
  <name>Enforce bounded manual outputs and STOP reset</name>
  <files>src/control/handlers.rs</files>
  <action>
    Clamp or reject manual heater/fan setpoints to 0–100% within handlers, ensuring invalid values are ignored and STOP clears manual values to 0 with pid/artisan flags reset. Keep pid_enabled/artisan_control consistent with current mode.
  </action>
  <verify>
    cargo test --test command_idempotence manual_bounds_and_reset
  </verify>
  <done>
    Manual commands never set outputs beyond 0–100%, invalid inputs have no side effects, and STOP reliably resets outputs and flags.
  </done>
</task>

<task type="auto">
  <name>Lock READ response determinism</name>
  <files>src/output/artisan.rs, tests/command_idempotence.rs</files>
  <action>
    Ensure format_read_response always returns ET,BT,Power,Fan with fixed one-decimal precision and no extra fields; add tests that call READ multiple times to confirm stability across updates and after STOP/START cycles.
  </action>
  <verify>
    cargo test --test command_idempotence read_response_deterministic
  </verify>
  <done>
    READ responses remain stable in field order and precision across repeated calls and state transitions.
  </done>
</task>

</tasks>

<verification>
Run cargo test --test command_idempotence to confirm START/STOP idempotence, bounded manual outputs, and stable READ formatting; ensure no regressions in existing tests.
</verification>

<success_criteria>
- Repeated START keeps streaming enabled without duplicating or resetting sessions
- Repeated STOP leaves outputs at 0, streaming disabled, and state consistent
- Manual OT1/IO3 bounded within 0–100% and cleared on STOP
- READ responses consistently include ET,BT,Power,Fan with fixed precision and order
</success_criteria>

<output>
After completion, create `.planning/phases/08-command-hardening/08-02-SUMMARY.md`
</output>
