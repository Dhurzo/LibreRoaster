---
phase: 04-code-removal
plan: "03"
type: execute
wave: 2
depends_on:
  - 04-01
  - 04-02
files_modified:
  - src/control/abstractions.rs
  - src/lib.rs
autonomous: true
user_setup: []
must_haves:
  truths:
    - "Wrapper OutputManager impl removed from abstractions.rs"
    - "Unused imports cleaned up in abstractions.rs"
    - "lib.rs exports only necessary modules"
    - "Project compiles and runs cleanly"
  artifacts:
    - path: src/control/abstractions.rs
      provides: "Cleaned up - removed wrapper impl and unused imports"
    - path: src/lib.rs
      provides: "Cleaned up - only necessary modules exported"
  key_links:
    - from: src/lib.rs
      to: "All modules"
      via: "Minimal export surface"
---

<objective>
Clean up remaining artifacts from deleted modules:
1. Remove OutputManager wrapper trait impl in abstractions.rs
2. Remove unused imports in abstractions.rs
3. Clean up lib.rs exports if needed
4. Verify final build succeeds
</objective>

<execution_context>
@/home/juan/.config/opencode/get-shit-done/workflows/execute-plan.md
@/home/juan/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/STATE.md
@.planning/ROADMAP.md
@.planning/PROJECT.md
@.planning/phases/04-code-removal/04-CONTEXT.md

# Remaining cleanup tasks

## abstractions.rs cleanup needed

The file src/control/abstractions.rs contains:
1. OutputManager trait definition (wrapper for output::OutputManager)
2. OutputManager impl block for output::OutputManager (wrapper impl - DELETE)
3. Unused imports:
   - alloc::string::String
   - alloc::string::ToString
   - UartDriver
   - libreroaster::output::OutputFormatter
4. output_manager field in TemperatureCommandHandler (handlers.rs)

Since output::OutputManager no longer exists (deleted in plan 04-01),
the wrapper impl in abstractions.rs is orphaned and must be removed.

## lib.rs cleanup

Current lib.rs exports:
- pub mod application;  (used in binary? Check main.rs imports)
- pub mod config;      (used)
- pub mod control;     (used)
- pub mod error;       (defined but may not be needed)
- pub mod hardware;     (used)
- pub mod input;      (used)
- pub mod output;      (used)

The application module is exported but may not be needed in the lib
since main.rs instantiates AppBuilder directly.
</context>

<tasks>

<task type="auto">
  <name>Remove OutputManager wrapper impl from abstractions.rs</name>
  <files>src/control/abstractions.rs</files>
  <action>
    Remove the OutputManager trait implementation block from abstractions.rs

    Find and delete this section:
    ```rust
    /// ImplementaciÃ³n del trait OutputManager para el OutputManager existente
    impl OutputManager for crate::output::OutputManager {
        type Error = crate::output::OutputError;
        
        async fn process_status(&mut self, status: &crate::config::SystemStatus) -> Result<(), Self::Error> {
            self.process_status(status).await
        }
        
        fn reset(&mut self) {
            self.reset()
        }
        
        fn enable_continuous_output(&mut self) {
            self.enable_continuous_output()
        }
        
        fn disable_continuous_output(&mut self) {
            self.disable_continuous_output()
        }
    }
    ```

    Keep the OutputManager trait definition itself if it's still used,
    but remove the impl block for the deleted output::OutputManager.
  </action>
  <verify>
    grep -q "impl OutputManager for crate::output::OutputManager" src/control/abstractions.rs && echo "ERROR: Impl still present" || echo "Wrapper impl removed"
  </verify>
  <done>
    Orphaned OutputManager impl block deleted
  </done>
</task>

<task type="auto">
  <name>Remove unused imports in abstractions.rs</name>
  <files>src/control/abstractions.rs</files>
  <action>
    Remove unused import statements from abstractions.rs

    Delete these unused imports:
    - use alloc::string::String;
    - use alloc::string::ToString;
    - use UartDriver;
    - use libreroaster::output::OutputFormatter;
    
    Keep necessary imports for remaining code.
  </action>
  <verify>
    grep "use alloc::string::String" src/control/abstractions.rs && echo "ERROR: Unused import still present" || echo "String import cleaned"
    grep "use UartDriver" src/control/abstractions.rs && echo "ERROR: UartDriver import still present" || echo "UartDriver import cleaned"
  </verify>
  <done>
    All unused imports removed from abstractions.rs
  </done>
</task>

<task type="auto">
  <name>Verify lib.rs exports are minimal</name>
  <files>src/lib.rs</files>
  <action>
    Review src/lib.rs and ensure only necessary modules are exported

    Current exports:
    - pub mod application;  (may not be needed in library)
    - pub mod config;      
    - pub mod control;     
    - pub mod error;      
    - pub mod hardware;    
    - pub mod input;      
    - pub mod output;     

    The application module may not need to be public if it's only used
    internally by main.rs. However, keeping it exported doesn't hurt.

    If application is only used in main.rs, we could consider making it private.
    But this is optional cleanup - the important thing is removing dead code.

    Option A: Keep as-is (conservative)
    Option B: Remove pub from application if not needed externally

    Since this is a firmware library, most modules are internal anyway.
    Leave lib.rs mostly as-is, focusing on the actual deletions.
  </action>
  <verify>
    cat src/lib.rs
    echo "---"
    echo "Verify exports look reasonable"
  </verify>
  <done>
    lib.rs exports reviewed (no changes needed for cleanup)
  </done>
</task>

<task type="auto">
  <name>Final build verification</name>
  <files>src/lib.rs</files>
  <action>
    Run cargo check to verify all deletions succeeded and project compiles

    ```bash
    cargo check 2>&1
    ```

    Address any compilation errors that arise from the deletions.
  </action>
  <verify>
    cargo check 2>&1 | tail -20
    cargo check 2>&1 | grep -q "error" && echo "ERRORS FOUND" || echo "Build successful"
  </verify>
  <done>
    cargo check succeeds with no errors
  </done>
</task>

</tasks>

<verification>
After completing all tasks:

1. Verify wrapper impl removed:
   ```bash
   grep -c "impl OutputManager for crate::output::OutputManager" src/control/abstractions.rs
   # Should be 0
   ```

2. Verify unused imports removed:
   ```bash
   grep "use alloc::string" src/control/abstractions.rs
   # Should be empty
   ```

3. Final build check:
   ```bash
   cargo check 2>&1 | tail -10
   ```

4. Verify no warnings about deleted modules
</verification>

<success_criteria>
- OutputManager wrapper impl removed from abstractions.rs
- Unused imports cleaned up from abstractions.rs
- lib.rs exports reviewed
- cargo check succeeds
- No compilation warnings or errors
</success_criteria>

<output>
After completion, create `.planning/phases/04-code-removal/04-03-SUMMARY.md`
</output>
