---
phase: 36-READ-Telemetry
plan: "01"
type: execute
wave: 1
depends_on: []
files_modified:
  - src/output/artisan.rs
  - src/control/roaster_refactored.rs
autonomous: true
user_setup: []
must_haves:
  truths:
    - "READ command triggers ArtisanFormatter.format_read_response()"
    - "CSV format matches spec: ET,BT,-1,-1,-1,FAN,HEATER"
    - "FAN and HEATER values with one decimal (e.g., 75.0)"
    - "Comment on variable: 'store value for future et2 and bt2 support'"
    - "Malformed output triggers heater stop and panic"
  artifacts:
    - path: "src/output/artisan.rs"
      provides: "ArtisanFormatter with CSV response format"
      min_lines: 5
    - path: "src/control/roaster_refactored.rs"
      provides: "READ command handler calling formatter"
      exports: ["format_read_response"]
  key_links:
    - from: "src/input/parser.rs"
      to: "src/output/artisan.rs"
      via: "READ command → format_read_response() call"
      pattern: "ReadStatus.*format_read_response"
---

<objective>
Wire ArtisanFormatter response to READ command. When Artisan sends READ, call `format_read_response()` and return CSV telemetry with one-decimal FAN/HEATER values. Add comment on variable storage for BT2/ET2 support. Panic on malformed output.

Purpose: Enable Artisan software to read current telemetry via READ command
Output: CSV response ET,BT,-1,-1,-1,FAN.HEATER with one-decimal values
</objective>

<execution_context>
@/home/juan/.config/opencode/get-shit-done/workflows/execute-plan.md
@/home/juan/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/STATE.md
@.planning/ROADMAP.md
@.planning/phases/36-READ-Telemetry/36-CONTEXT.md

# Prior patterns to follow
src/output/artisan.rs           # ArtisanFormatter implementation
src/control/roaster_refactored.rs  # READ command handler reference
src/input/parser.rs              # READ command parsing (already exists)

# Key decisions from CONTEXT.md
- FAN and HEATER with one decimal (e.g., "75.0")
- Comment: "store value for future et2 and bt2 support" on variable
- Malformed output → stop heater + panic
</context>

<tasks>

<task type="auto">
  <name>Update format_read_response with one-decimal values and comment</name>
  <files>src/output/artisan.rs</files>
  <action>
    1. Find format_read_response() function in artisan.rs
    2. Update FAN and HEATER value formatting:
       - Format as one decimal (e.g., 75.0, 100.0)
       - Reference fan.get_speed() and heater.get_power() or similar
    3. Add comment on variable storage location:
       - Text: "store value for future et2 and bt2 support"
       - Place near where BT/ET values are stored/processed
    4. Ensure CSV format matches spec: ET,BT,-1,-1,-1,FAN,HEATER\r\n
    5. Keep BT2/ET2 returning -1 per Artisan spec
  </action>
  <verify>
    <verify_command>cargo check --features std 2>&1 | grep -E "(error|warning:.*artisan)" || echo "✓ No artisan errors"</verify_command>
  </verify>
  <done>
    format_read_response() returns CSV with one-decimal FAN/HEATER and comment on variable
  </done>
</task>

<task type="auto">
  <name>Add error handling with heater stop and panic</name>
  <files>src/control/roaster_refactored.rs</files>
  <action>
    1. Find READ command handler in roaster_refactored.rs
    2. Add error handling around format_read_response() call:
       - If error returned: stop heater, panic with message
       - If malformed output detected: stop heater, panic
    3. Reference existing error handling patterns in file
  </action>
  <verify>
    cargo check --features std 2>&1 | grep -E "(error|warning:.*roaster)" || echo "✓ No roaster errors"
  </verify>
  <done>
    READ command handler stops heater and panics on format_read_response error
  </done>
</task>

<task type="auto">
  <name>Add tests for READ response format</name>
  <files>src/output/artisan.rs</files>
  <action>
    1. Find existing tests in artisan.rs
    2. Add test for format_read_response with one-decimal values:
       - Verify FAN/HEATER show one decimal format
       - Verify BT2/ET2 return -1
       - Verify CSV format is correct
    3. Tests use existing test infrastructure
  </action>
  <verify>
    cargo test --features std -- artisan::tests 2>&1 | grep -E "(test.*READ|passed|failed)" | head -10
  </verify>
  <done>
    All READ response format tests pass including one-decimal verification
  </done>
</task>

</tasks>

<verification>
After all tasks complete:
1. cargo check --features std passes
2. cargo test --features std passes (READ tests)
3. CSV format verified: ET,BT,-1,-1,-1,FAN,HEATER
</verification>

<success_criteria>
- [x] READ triggers format_read_response() call
- [x] CSV format matches spec
- [x] FAN/HEATER with one decimal (75.0)
- [x] Comment on variable: "store value for future et2 and bt2 support"
- [x] Malformed output → stop heater + panic
- [x] BT2/ET2 return -1 per spec
- [x] Tests verify one-decimal format
</success_criteria>

<output>
After completion, create `.planning/phases/36-READ-Telemetry/36-01-SUMMARY.md`
</output>
