---
phase: 37-UNITS-Parsing
plan: "01"
type: execute
wave: 1
depends_on: []
files_modified:
  - src/config/constants.rs
  - src/input/parser.rs
  - src/input/init_state.rs
autonomous: true
user_setup: []
must_haves:
  truths:
    - "Parser accepts UNITS,C and UNITS,F commands during init"
    - "Temperature scale stored in separate struct (default: Celsius)"
    - "Silent execution — no ACK response on success"
    - "Invalid mode triggers ERR response"
    - "No temperature conversion applied (parse only)"
  artifacts:
    - path: "src/config/constants.rs"
      provides: "TemperatureScale enum and storage struct"
      exports: ["TemperatureScale", "TemperatureSettings"]
    - path: "src/input/parser.rs"
      provides: "UNITS command parsing"
      exports: ["parse_units_command"]
    - path: "src/input/init_state.rs"
      provides: "Init state handler for UNITS"
      exports: ["handle_units_command"]
  key_links:
    - from: "src/input/parser.rs"
      to: "src/config/constants.rs"
      via: "UNITS parsing → TemperatureScale storage"
      pattern: "Units.*TemperatureScale"
---

<objective>
Implement UNITS command parsing for temperature scale preference. Command parses UNITS,C or UNITS,F during init, stores preference in separate struct, no temperature conversion applied.

Purpose: Enable Artisan to set temperature scale preference (Celsius/Fahrenheit) during initialization
Output: Temperature scale preference stored, no conversion applied
</objective>

<execution_context>
@/home/juan/.config/opencode/get-shit-done/workflows/execute-plan.md
@/home/juan/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/STATE.md
@.planning/ROADMAP.md
@.planning/phases/37-UNITS-Parsing/37-CONTEXT.md

# Key decisions from CONTEXT.md
- Separate struct for temperature scale preference
- Silent execution (no ACK)
- Init only, default to Celsius
- ERR on invalid mode (Claude's discretion on specifics)

# Prior patterns to follow
src/input/init_state.rs  # Init command handling pattern
src/input/parser.rs      # Existing UNITS parsing (for init handshake)
src/config/constants.rs  # ArtisanCommand enum with Units variant
</context>

<tasks>

<task type="auto">
  <name>Create TemperatureScale enum and storage struct</name>
  <files>src/config/constants.rs</files>
  <action>
    1. Add TemperatureScale enum:
       - Celsius variant
       - Fahrenheit variant
       - Default: Celsius
    2. Add TemperatureSettings struct:
       - scale: TemperatureScale field
       - new() constructor with default Celsius
       - get_scale() / set_scale() methods
    3. Place in appropriate module (config/constants.rs or new config/temperature.rs)
    4. Follow existing enum patterns in codebase
  </action>
  <verify>
    cargo check --features std 2>&1 | grep -E "(error|warning:.*config)" || echo "✓ No config errors"
  </verify>
  <done>
    TemperatureScale enum and TemperatureSettings struct created with default Celsius
  </done>
</task>

<task type="auto">
  <name>Update UNITS parser to use new storage</name>
  <files>src/input/parser.rs</files>
  <action>
    1. Find existing UNITS parsing in parser.rs (init handshake)
    2. Update to store preference in TemperatureSettings:
       - Parse UNITS,C or UNITS,F
       - Return ArtisanCommand::Units(bool) where true = Fahrenheit
       - Invalid mode returns ParseError::InvalidValue
    3. Keep semicolon delimiter (init command pattern)
    4. Add tests for:
       - UNITS,C → Celsius
       - UNITS,F → Fahrenheit
       - UNITS,X → InvalidValue error
       - Case insensitivity
  </action>
  <verify>
    cargo test --features std -- parser::tests 2>&1 | grep -E "(test.*units|passed|failed)" | head -10
  </verify>
  <done>
    Parser accepts UNITS,C/F, stores preference, returns ERR on invalid
  </done>
</task>

<task type="auto">
  <name>Wire storage to init state handler</name>
  <files>src/input/init_state.rs</files>
  <action>
    1. Find init state handling for UNITS command
    2. Update to use TemperatureSettings struct:
       - Create or access TemperatureSettings instance
       - Store scale preference when UNITS received
       - No response sent (silent execution)
    3. Ensure default is Celsius if UNITS not received
    4. Verify integration with existing init flow (CHAN→UNITS→FILT)
  </action>
  <verify>
    cargo check --features std 2>&1 | grep -E "(error|warning:.*init)" || echo "✓ No init errors"
  </verify>
  <done>
    Init handler stores UNITS preference, silent execution, default Celsius
  </done>
</task>

</tasks>

<verification>
After all tasks complete:
1. cargo test --features std passes (including UNITS tests)
2. cargo check --features std passes
3. cargo clippy passes
</verification>

<success_criteria>
- [x] TemperatureScale enum created (Celsius, Fahrenheit)
- [x] TemperatureSettings struct created with default Celsius
- [x] Parser accepts UNITS,C and UNITS,F
- [x] Invalid mode returns ERR
- [x] Silent execution on success
- [x] No temperature conversion applied
- [x] Init flow integration verified
</success_criteria>

<output>
After completion, create `.planning/phases/37-UNITS-Parsing/37-01-SUMMARY.md`
</output>
