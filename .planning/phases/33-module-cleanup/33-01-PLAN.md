---
phase: 33-module-cleanup
plan: 01
type: execute
wave: 1
depends_on: []
files_modified: []
autonomous: true
must_haves:
  truths:
    - "All 44 src/ files cleaned of noise comments"
    - "All 8 tests/ files cleaned of noise comments"
    - "All rationale comments preserved (protocol refs, workarounds, historical)"
    - "cargo build passes after cleanup"
    - "cargo test passes after cleanup"
  artifacts:
    - path: "src/**/*.rs"
      provides: "Cleaned source files with noise comments removed"
      min_lines: 0
    - path: "tests/**/*.rs"
      provides: "Cleaned test files with noise comments removed"
      min_lines: 0
  key_links:
    - from: "src/**/*.rs"
      to: ".planning/comment-inventory.md"
      via: "classification reference"
      pattern: "noise.*remove"
    - from: "src/**/*.rs"
      to: "33-CONTEXT.md"
      via: "keep rules"
      pattern: "protocol.*workaround.*historical"
---

<objective>
Clean all Rust source files by removing noise comments and preserving rationale explanations.

Purpose: Improve code readability by removing comments that don't add value, while keeping design rationale, protocol references, workarounds, and historical context.

Output: Cleaned source and test files with noise comments removed.
</objective>

<execution_context>
@/home/juan/.config/opencode/get-shit-done/workflows/execute-plan.md
@/home/juan/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/STATE.md
@.planning/ROADMAP.md
@/home/juan/Repos/LibreRoaster/.planning/phases/33-module-cleanup/33-CONTEXT.md
@.planning/comment-inventory.md

# Classification Rules (from 33-CONTEXT.md)

## Remove (Noise Comments)

- **API doc comments (///)** — Remove all
- **TODO/FIXME comments** — Remove
- **Noise comments** — Obvious statements, code duplication
- **Commented-out code** — Remove (unless historical context exists)
- **Closing brace comments** — Remove

## Keep (Rationale Comments)

- **Protocol references** — Artisan protocol spec references in parser, multiplexer, init_state
- **Hardware workarounds** — ESP32-specific quirks in hardware modules
- **Historical context** — Why code was disabled/changed
- **Non-obvious logic** — Complex algorithm explanations

## Files by Category

**Application Core (clean first):**
- src/application/app_builder.rs
- src/application/service_container.rs
- src/application/tasks.rs

**Hardware Drivers:**
- src/hardware/uart/driver.rs
- src/hardware/uart/buffer.rs
- src/hardware/uart/tasks.rs
- src/hardware/usb_cdc/driver.rs
- src/hardware/usb_cdc/tasks.rs
- src/hardware/max31856.rs
- src/hardware/fan.rs
- src/hardware/pid.rs
- src/hardware/ssr.rs
- src/hardware/board.rs

**Protocol Modules (KEEP protocol refs):**
- src/input/parser.rs
- src/input/multiplexer.rs
- src/input/init_state.rs
- src/output/artisan.rs

**Control Logic:**
- src/control/handlers.rs
- src/control/pid.rs
- src/control/abstractions.rs
- src/control/traits.rs
- src/control/roaster_refactored.rs

**Entry Points (last):**
- src/main.rs
- src/lib.rs

**Test Files (after src/):**
- tests/artisan_integration_test.rs
- tests/command_errors.rs
- tests/command_idempotence.rs
- tests/mock_uart_integration.rs
- tests/mock_uart.rs
- tests/mock_usb_driver.rs
- tests/multiplexer_tests.rs
- tests/usb_cdc_tests.rs
</context>

<tasks>

<task type="auto">
  <name>Clean application core modules</name>
  <files>src/application/app_builder.rs src/application/service_container.rs src/application/tasks.rs</files>
  <action>
    Clean the application core modules first (as per 33-CONTEXT.md processing order).

    For each file:
    1. Open the file
    2. Identify comments using classification rules:
       - REMOVE: API doc comments (///), TODO/FIXME, noise, commented-out code
       - KEEP: Non-obvious logic, workarounds, historical context
    3. Remove identified noise comments
    4. Verify file still compiles (rust-analyzer check or read-only check)
    5. Move to next file

    Reference .planning/comment-inventory.md for comment counts per file.

    DO NOT:
    - Refactor code
    - Change logic
    - Reformat code
    - Add new comments

    DO:
    - Remove only noise comments
    - Preserve all rationale (protocol refs, workarounds, historical)
  </action>
  <verify>
    ls -la src/application/*.rs | wc -l && grep -c "^///" src/application/*.rs || echo "Doc comments removed"
  </verify>
  <done>
    Application core modules cleaned
  </done>
</task>

<task type="auto">
  <name>Clean hardware driver modules</name>
  <files>src/hardware/uart/driver.rs src/hardware/uart/buffer.rs src/hardware/uart/tasks.rs src/hardware/usb_cdc/driver.rs src/hardware/usb_cdc/tasks.rs src/hardware/max31856.rs src/hardware/fan.rs src/hardware/pid.rs src/hardware/ssr.rs src/hardware/board.rs</files>
  <action>
    Clean hardware driver modules (second in processing order).

    For each file:
    1. Open the file
    2. Identify comments using classification rules:
       - REMOVE: API doc comments (///), TODO/FIXME, noise, commented-out code
       - KEEP: Hardware workarounds (ESP32 quirks), non-obvious logic
    3. Remove identified noise comments
    4. Verify file structure intact

    Pay special attention to:
    - Workaround comments for hardware limitations — KEEP
    - Peripheral initialization comments — KEEP if non-obvious
    - Protocol-related comments in UART/USB modules — REVIEW (may be protocol refs)
  </action>
  <verify>
    ls -la src/hardware/**/*.rs | wc -l
  </verify>
  <done>
    Hardware driver modules cleaned
  </done>
</task>

<task type="auto">
  <name>Clean protocol modules (preserve protocol refs)</name>
  <files>src/input/parser.rs src/input/multiplexer.rs src/input/init_state.rs src/output/artisan.rs</files>
  <action>
    Clean protocol modules (third in processing order).

    CRITICAL: These files contain Artisan protocol reference comments that MUST be kept.

    For each file:
    1. Open the file
    2. Carefully classify comments:
       - REMOVE: API doc comments (///), TODO/FIXME, noise
       - KEEP: Protocol references (Artisan spec), state machine logic, command handling explanations
    3. Review each comment before removal
    4. If unsure, mark with "?" to review later

    Protocol reference indicators:
    - Comments mentioning "Artisan", "protocol", "command"
    - State machine state explanations
    - Channel/filter initialization rationale
  </action>
  <verify>
    grep -c "Artisan\|protocol\|command" src/input/*.rs src/output/artisan.rs || echo "Protocol refs found"
  </verify>
  <done>
    Protocol modules cleaned with protocol refs preserved
  </done>
</task>

<task type="auto">
  <name>Clean control logic modules</name>
  <files>src/control/handlers.rs src/control/pid.rs src/control/abstractions.rs src/control/traits.rs src/control/roaster_refactored.rs</files>
  <action>
    Clean control logic modules (fourth in processing order).

    For each file:
    1. Open the file
    2. Identify comments using classification rules:
       - REMOVE: API doc comments (///), TODO/FIXME, noise
       - KEEP: Non-obvious logic, algorithm explanations
    3. Remove identified noise comments

    Focus on:
    - PID control explanations — KEEP if non-obvious
    - Handler logic comments — REVIEW individually
    - Trait documentation — REMOVE (API docs)
  </action>
  <verify>
    ls -la src/control/*.rs | wc -l
  </verify>
  <done>
    Control logic modules cleaned
  </done>
</task>

<task type="auto">
  <name>Clean entry point files</name>
  <files>src/main.rs src/lib.rs</files>
  <action>
    Clean entry point files (last in processing order).

    For src/main.rs:
    - Remove noise comments
    - Keep board initialization rationale if non-obvious

    For src/lib.rs:
    - Remove module-level documentation (/// at top) — REMOVE per CONTEXT.md
    - Keep inline rationale comments
  </action>
  <verify>
    wc -l src/main.rs src/lib.rs
  </verify>
  <done>
    Entry point files cleaned
  </done>
</task>

<task type="auto">
  <name>Clean config and error modules</name>
  <files>src/config/constants.rs src/config/mod.rs src/error/app_error.rs src/error/mod.rs</files>
  <action>
    Clean config and error modules (missing from main list but in src/).

    For src/error/app_error.rs:
    - Remove all API doc comments (///) — REMOVE
    - Keep inline error explanation comments

    For src/config/constants.rs:
    - Review constant documentation comments — REMOVE noise, keep rationale
  </action>
  <verify>
    ls -la src/config/ src/error/ | wc -l
  </verify>
  <done>
    Config and error modules cleaned
  </done>
</task>

<task type="auto">
  <name>Clean logging modules</name>
  <files>src/logging/channel.rs src/logging/drain_task.rs src/logging/mod.rs src/logging/tests.rs</files>
  <action>
    Clean logging modules.

    For each file:
    1. Apply classification rules
    2. Remove noise comments
    3. Keep non-obvious logging logic explanations
  </action>
  <verify>
    ls -la src/logging/*.rs | wc -l
  </verify>
  <done>
    Logging modules cleaned
  </done>
</task>

<task type="auto">
  <name>Clean remaining hardware modules</name>
  <files>src/hardware/mod.rs src/hardware/shared_spi.rs src/hardware/fan_host.rs src/hardware/usb_cdc_host.rs src/hardware/usb_cdc/mod.rs</files>
  <action>
    Clean remaining hardware modules.

    These may have fewer comments to review.
  </action>
  <verify>
    ls -la src/hardware/*.rs | wc -l
  </verify>
  <done>
    Remaining hardware modules cleaned
  </done>
</task>

<task type="auto">
  <name>Clean test files</name>
  <files>tests/artisan_integration_test.rs tests/command_errors.rs tests/command_idempotence.rs tests/mock_uart_integration.rs tests/mock_uart.rs tests/mock_usb_driver.rs tests/multiplexer_tests.rs tests/usb_cdc_tests.rs</files>
  <action>
    Clean test files (after all src/ complete).

    For each test file:
    1. Remove API doc comments (///)
    2. Remove TODO/FIXME comments
    3. Remove noise comments
    4. Keep test logic explanations if non-obvious

    Note: Test doc comments should be removed (per 33-CONTEXT.md decision).
  </action>
  <verify>
    ls -la tests/*.rs | wc -l
  </verify>
  <done>
    Test files cleaned
  </done>
</task>

<task type="auto">
  <name>Verify cleanup and commit</name>
  <files></files>
  <action>
    Perform final verification and commit:

    **Step 1: cargo build**
    ```bash
    cargo build 2>&1
    ```
    - If build fails, identify and fix the issue
    - Common issue: accidentally removed a comment that was needed for cfg attributes

    **Step 2: cargo test**
    ```bash
    cargo test 2>&1
    ```
    - All tests should pass
    - If tests fail, investigate cleanup impact

    **Step 3: Automated diff review**
    Check that key rationale comments still exist:
    ```bash
    # Check for protocol refs in protocol modules
    grep -r "Artisan\|protocol\|command" src/input/ src/output/artisan.rs

    # Check for hardware workarounds
    grep -r "ESP32\|hardware\|quirk" src/hardware/

    # Count removed comments (should be high)
    echo "Comments removed - build passed"
    ```

    **Step 4: Git operations**
    - Add all cleaned files
    - Commit with clear message describing cleanup

    **Step 5: Update STATE.md**
    - Mark Phase 33 as complete
  </action>
  <verify>
    cargo build && cargo test && echo "Verification complete"
  </verify>
  <done>
    Cleanup verified, build passes, tests pass, committed
  </done>
</task>

</tasks>

<verification>
- [ ] All 44 src/ files cleaned
- [ ] All 8 tests/ files cleaned
- [ ] cargo build passes without errors
- [ ] cargo test passes all tests
- [ ] Protocol reference comments preserved in input/output modules
- [ ] Hardware workaround comments preserved in hardware modules
- [ ] Changes committed with clear message
</verification>

<success_criteria>
- [ ] All noise comments removed (doc comments, TODO, noise, commented-out code)
- [ ] All rationale comments preserved (protocol refs, workarounds, historical)
- [ ] Build passes
- [ ] Tests pass
- [ ] Single commit at end of Phase 33
</success_criteria>

<output>
After completion, create `.planning/phases/33-module-cleanup/33-01-SUMMARY.md` with:
- Files cleaned (count)
- Comments removed (estimate)
- Verification results (build, test status)
- Any issues encountered
</output>
