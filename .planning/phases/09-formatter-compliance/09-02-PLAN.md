---
phase: 09-formatter-compliance
plan: "02"
type: execute
wave: 1
depends_on: []
files_modified:
  - src/input/parser.rs
  - src/hardware/uart/tasks.rs
  - src/control/abstractions.rs
  - src/application/tasks.rs
  - tests/command_errors.rs
autonomous: true

must_haves:
  truths:
    - "All error responses follow a stable 'ERR <code> <message>' schema"
    - "Empty, malformed, and out-of-range inputs emit parseable ERR lines with canonical codes"
    - "Handler failures emit ERR handler_failed with bounded message tokens (no debug payloads)"
  artifacts:
    - path: "src/input/parser.rs"
      provides: "ParseError code/message mapping"
    - path: "src/hardware/uart/tasks.rs"
      provides: "Parse error emission with ERR code/message"
    - path: "src/control/abstractions.rs"
      provides: "RoasterError message token mapping"
    - path: "src/application/tasks.rs"
      provides: "Handler error emission with ERR code/message"
    - path: "tests/command_errors.rs"
      provides: "Schema assertions for ERR responses"
  key_links:
    - from: "src/hardware/uart/tasks.rs"
      to: "src/input/parser.rs"
      via: "ParseError code/message helpers"
      pattern: "ERR .*\s"
    - from: "src/application/tasks.rs"
      to: "src/control/abstractions.rs"
      via: "RoasterError message token"
      pattern: "handler_failed"
---

<objective>
Standardize ERR response schema for parse and handler failures.

Purpose: Provide stable, parseable error output aligned with FMT-02.
Output: Unified error code/message formatting and updated error tests.
</objective>

<execution_context>
@/home/juan/.config/opencode/get-shit-done/workflows/execute-plan.md
@/home/juan/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09-formatter-compliance/09-RESEARCH.md
@.planning/phases/08-command-hardening/08-01-SUMMARY.md
@src/input/parser.rs
@src/hardware/uart/tasks.rs
@src/control/abstractions.rs
@src/application/tasks.rs
@tests/command_errors.rs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add canonical error code/message helpers</name>
  <files>src/input/parser.rs, src/control/abstractions.rs</files>
  <action>
Introduce `code()` and `message()` helpers for `ParseError` and a bounded message token helper for `RoasterError`. Map `EmptyCommand` to code `invalid_value` with message `empty_command` to align with the canonical reason codes. Keep tokens lowercase with underscores and no spaces for parsing stability.
  </action>
  <verify>rg "code\(\)|message\(\)" src/input/parser.rs src/control/abstractions.rs</verify>
  <done>Errors expose stable code/message tokens suitable for ERR output.</done>
</task>

<task type="auto">
  <name>Task 2: Emit ERR lines with consistent schema</name>
  <files>src/hardware/uart/tasks.rs, src/application/tasks.rs</files>
  <action>
Update `send_parse_error` to emit `ERR <code> <message>` using `ParseError` helpers. Update `send_handler_error` to emit `ERR handler_failed <message>` using the new `RoasterError` token mapping, removing debug payloads/colons. Preserve CRLF termination at UART boundary only.
  </action>
  <verify>rg "ERR" src/hardware/uart/tasks.rs src/application/tasks.rs</verify>
  <done>All ERR output paths use the same code/message schema without debug text.</done>
</task>

<task type="auto">
  <name>Task 3: Align error tests with schema</name>
  <files>tests/command_errors.rs</files>
  <action>
Update existing tests to assert `ERR <code> <message>` tokenization (3 fields) for empty, unknown, invalid, and out-of-range commands. Keep checks for no command enqueue side effects.
  </action>
  <verify>cargo test --test command_errors</verify>
  <done>Tests validate stable ERR schema and error codes for invalid input paths.</done>
</task>

</tasks>

<verification>
- `cargo test --test command_errors` (acknowledge host target may require embedded target/stubs)
- Manual review: ERR output schema is `ERR <code> <message>` for parse and handler errors
</verification>

<success_criteria>
- Error responses use a consistent code/message schema across parse and handler failures.
- Invalid inputs yield stable, parseable ERR output with canonical codes.
</success_criteria>

<output>
After completion, create `.planning/phases/09-formatter-compliance/09-02-SUMMARY.md`
</output>
