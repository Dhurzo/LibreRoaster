---
phase: 31-linting-audit
plan: "01"
type: execute
wave: 1
depends_on: []
files_modified:
  - clippy.toml
  - Cargo.toml
autonomous: true
user_setup: []
must_haves:
  truths:
    - "cargo-clippy runs without errors on the codebase"
    - "Embedded-specific lint rules are active (no unwrap/panic in production)"
    - "clippy.toml configuration is saved to version control"
  artifacts:
    - path: "clippy.toml"
      provides: "Lint configuration with disallow rules for embedded Rust"
      min_lines: 15
    - path: "Cargo.toml"
      provides: "Updated manifest with clippy configuration"
      contains: "[lints.clippy]"
  key_links:
    - from: "clippy.toml"
      to: "All source files"
      via: "cargo clippy --all-targets"
      pattern: "clippy\\.toml controls lint enforcement"
---

<objective>
Configure cargo-clippy with embedded-specific lint rules to prevent unwrap(), expect(), and panic!() usage that can crash the ESP32-C3 firmware.
</objective>

<execution_context>
@/home/juan/.config/opencode/get-shit-done/workflows/execute-plan.md
@/home/juan/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/research/code-quality-rust-RESEARCH.md

**Embedded Rust Constraints:**
- Cloudflare November 2025 outage caused by unhandled unwrap() in production
- embassy-rs: panic in one task crashes entire executor
- No_std environment: cannot use standard panic handlers

**Lint Configuration:**
- disallow = ["unwrap_used", "expect_used", "panic"]
- Allow these in tests: allow = ["unwrap_used", "expect_used", "panic"]
- Severity: Critical for production code

**Relevant Codebase:**
- 44 Rust source files in src/
- 39 occurrences of unwrap/panic/unsafe flagged
</context>

<tasks>

<task type="auto">
  <name>Create clippy.toml with embedded-specific lint rules</name>
  <files>clippy.toml</files>
  <action>
    Create clippy.toml in project root with the following configuration:

    1. Disallow unwrap_used, expect_used, panic in ALL targets (including lib, bins)
    2. Allow these lints in [dev-dependencies] and test modules
    3. Add severity configuration:
       - unwrap_used = "deny"
       - expect_used = "deny"
       - panic = "deny"
    4. Set type_complexity_threshold = 50 for embedded code clarity
    5. Add cognitive_complexity_threshold = 20

    Reference research findings: The Cloudflare outage and embassy-rs crash demonstrate that embedded systems cannot tolerate panics. Configuration must be strict for production code.
  </action>
  <verify>
    cat clippy.toml && echo "---" && cargo clippy --all-targets 2>&1 | head -50
  </verify>
  <verify_after>
    cargo clippy --all-targets 2>&1 | grep -E "(error|warning:.*unwrap|warning:.*panic)" | wc -l
  </verify_after>
  <done>
    clippy.toml exists with disallow rules, and cargo clippy runs (may show warnings but no config errors)
  </done>
</task>

<task type="auto">
  <name>Verify clippy configuration works across all targets</name>
  <files>Cargo.toml</files>
  <action>
    Run cargo clippy on all targets to verify configuration is active:

    1. cargo clippy --lib    # Library code (most restrictive)
    2. cargo clippy --bins   # Binary targets
    3. cargo clippy --tests  # Test targets (lints allowed here)
    4. cargo clippy --doc    # Documentation tests

    Document which lints fire in each target. The lib target should show the most violations since that's where production restrictions apply.
  </action>
  <verify>
    cargo clippy --all-targets 2>&1 | tee /tmp/clippy-output.txt | tail -30
  </verify>
  <verify_after>
    grep -c "unwrap" /tmp/clippy-output.txt || echo "0"
  </verify_after>
  <done>
    cargo clippy completes successfully, configuration is active, violations are being detected
  </done>
</task>

</tasks>

<verification>
**Configuration Verification:**
- [ ] clippy.toml exists in project root with disallow rules
- [ ] cargo clippy --lib runs without configuration errors
- [ ] cargo clippy --all-targets executes and reports lints
- [ ] At least one unwrap/panic lint fires (proves configuration is active)

**Lint Rules Active:**
- [ ] unwrap_used = deny
- [ ] expect_used = deny
- [ ] panic = deny
</verification>

<success_criteria>
- clippy.toml committed to git
- cargo clippy configuration is active and detecting violations
- Embedded-specific rules prevent unwrap/panic in production code
</success_criteria>

<output>
After completion, create `.planning/phases/31-linting-audit/31-01-SUMMARY.md` with:
- Configuration decisions made
- Lint violations discovered
- Files modified
</output>
