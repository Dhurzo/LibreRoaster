---
phase: 31-linting-audit
plan: "03"
type: execute
wave: 3
depends_on:
  - "31-01"
  - "31-02"
files_modified:
  - internalDoc/CODE_QUALITY_ISSUES.md
  - internalDoc/CODE_QUALITY_REMEDIATION.md
autonomous: true
user_setup: []
must_haves:
  truths:
    - "Complete grep inventory of all 44 source files for unwrap/panic/unsafe"
    - "All 39 flagged issues categorized by severity (Critical/High/Medium/Low)"
    - "Issue inventory created in internalDoc/ for developer reference"
    - "Recommended remediation approach documented for each issue"
  artifacts:
    - path: "internalDoc/CODE_QUALITY_ISSUES.md"
      provides: "Complete inventory of all code quality issues for developers"
      min_lines: 100
    - path: "internalDoc/CODE_QUALITY_REMEDIATION.md"
      provides: "Guidelines for fixing each category of issues"
      min_lines: 50
  key_links:
    - from: "CODE_QUALITY_ISSUES.md"
      to: "src/ files"
      via: "grep and manual analysis"
      pattern: "inventory links issues to source file line numbers"
    - from: "CODE_QUALITY_REMEDIATION.md"
      to: "CODE_QUALITY_ISSUES.md"
      via: "severity cross-references"
      pattern: "remediation provides fixes for inventoried issues"
---

<objective>
Run comprehensive audit on all 44 source files, categorize the 39 flagged issues by severity, create an issue inventory with file locations, and document recommended remediation approaches.
</objective>

<execution_context>
@/home/juan/.config/opencode/get-shit-done/workflows/execute-plan.md
@/home/juan/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/research/code-quality-rust-RESEARCH.md
@.planning/phases/31-linting-audit/31-01-SUMMARY.md
@.planning/phases/31-linting-audit/31-02-SUMMARY.md

**Codebase Context:**
- 44 Rust source files in src/
- 39 occurrences flagged of unwrap/panic/unsafe
- Largest files:
  - src/control/roaster_refactored.rs (476 lines)
  - src/control/handlers.rs (463 lines)
  - src/output/artisan.rs (453 lines)
  - src/input/parser.rs (388 lines)
  - src/hardware/ssr.rs (354 lines)

**Issue Categories:**
1. unwrap() on Result types
2. unwrap() on Option types
3. panic!() macro calls
4. expect() calls
5. unsafe {} blocks

**Severity Classification:**
- Critical: Production code that will crash ESP32-C3
- High: Likely to cause issues in specific conditions
- Medium: Code quality issues, may cause problems
- Low: Style/preference issues, low risk
</context>

<tasks>

<task type="auto">
  <name>Run comprehensive grep inventory on all source files</name>
  <files>internalDoc/CODE_QUALITY_ISSUES.md</files>
  <action>
    Run comprehensive grep analysis on all 44 source files:

    1. Find all unwrap() calls:
       grep -rn "\.unwrap()" src/ --include="*.rs" | grep -v test | grep -v bench

    2. Find all expect() calls:
       grep -rn "\.expect(" src/ --include="*.rs" | grep -v test | grep -v bench

    3. Find all panic!() macro calls:
       grep -rn "panic!" src/ --include="*.rs" | grep -v test | grep -v bench

    4. Find all unsafe blocks (already done in 31-02, reuse):
       Reference .planning/phases/31-linting-audit/geiger-report.md

    5. Compile results into a unified inventory with line numbers and context
  </action>
  <verify>
    echo "=== unwrap() count ===" && grep -rn "\.unwrap()" src/ --include="*.rs" | wc -l && \
    echo "=== expect() count ===" && grep -rn "\.expect(" src/ --include="*.rs" | wc -l && \
    echo "=== panic!() count ===" && grep -rn "panic!" src/ --include="*.rs" | wc -l
  </verify>
  <verify_after>
    TOTAL=$(($(grep -rn "\.unwrap()" src/ --include="*.rs" | wc -l) + $(grep -rn "\.expect(" src/ --include="*.rs" | wc -l) + $(grep -rn "panic!" src/ --include="*.rs" | wc -l))) && echo "Total: $TOTAL issues"
  </verify_after>
  <done>
    Complete grep inventory run, counts verified against expected 39 issues
  </done>
</task>

<task type="auto">
  <name>Create issue inventory with severity classification</name>
  <files>internalDoc/CODE_QUALITY_ISSUES.md</files>
  <action>
    Create comprehensive CODE_QUALITY_ISSUES.md with:

    1. **Inventory Summary Table:**
       - Category breakdown (unwrap/expect/panic/unsafe)
       - Total count per severity level
       - File distribution

    2. **Detailed Issue List (sorted by severity, then file):**

       For each issue, document:
       - **ID:** ISSUE-001, ISSUE-002, etc.
       - **File:** src/path/file.rs
       - **Line:** Line number
       - **Code:** The actual code snippet (2-3 lines context)
       - **Category:** unwrap/expect/panic/unsafe
       - **Severity:** Critical/High/Medium/Low
       - **Reasoning:** Why this severity
       - **Recommended Fix:** How to resolve

    3. **Severity Criteria:**
       - **Critical:** Production code path, no fallback, will crash ESP32-C3
       - **High:** High likelihood of failure, common error path
       - **Medium:** Could fail in edge cases, poor error handling
       - **Low:** Code style, defensive programming suggestion

    4. **File Breakdown:**
       - Issues per file
       - Total lines of code per file
       - Issues per 100 lines ratio
  </action>
  <verify>
    cat internalDoc/CODE_QUALITY_ISSUES.md | head -100
  </verify>
  <verify_after>
    grep -c "^### " internalDoc/CODE_QUALITY_ISSUES.md || echo "0"
  </verify_after>
  <done>
    Issue inventory created with all issues categorized by severity
  </done>
</task>

<task type="auto">
  <name>Create remediation guide with fix patterns</name>
  <files>internalDoc/CODE_QUALITY_REMEDIATION.md</files>
  <action>
    Create CODE_QUALITY_REMEDIATION.md with actionable fix patterns:

    1. **Remediation Patterns by Category:**

       **For unwrap() on Result:**
       - Use ? operator if error is recoverable
       - Use map_err to convert error types
       - Create custom error types with From implementations
       - Add default value if appropriate
       - Log error and continue with safe default

       **For unwrap() on Option:**
       - Use as_ref().map() chains
       - Provide default with unwrap_or()
       - Use filter() to skip None cases
       - Convert to Result with ok_or()

       **For panic!():**
       - Replace with proper error propagation
       - Use assert! only for invariant violations
       - Add logging before graceful degradation
       - Return Result types instead

       **For unsafe blocks:**
       - Document why unsafe is necessary
       - Keep unsafe blocks as small as possible
       - Add safety comments explaining invariants
       - Consider using safe abstractions (esp32-hal, embedded-hal)

    2. **Embedded-Specific Patterns:**
       - How to handle hardware errors gracefully
       - Using nb::block! for blocking operations
       - Error handling with embassy-time

    3. **Priority Order:**
       - Critical issues first (crash prevention)
       - High severity (likely failures)
       - Medium (code quality)
       - Low (style improvements)

    4. **Cross-Reference:**
       - Link each pattern to example fixes in the codebase
       - Reference external resources for error handling patterns
   </action>
  <verify>
    cat internalDoc/CODE_QUALITY_REMEDIATION.md | head -80
  </verify>
  <verify_after>
    grep -c "^## " internalDoc/CODE_QUALITY_REMEDIATION.md || echo "0"
  </verify_after>
  <done>
    Remediation guide created with actionable fix patterns for each issue category
  </done>
</task>

</tasks>

<verification>
**Inventory Completeness:**
- [ ] All 44 source files scanned
- [ ] All 39 issues from research accounted for
- [ ] Each issue has file path, line number, and code snippet
- [ ] All issues categorized by severity

**Documentation Quality:**
- [ ] Issue inventory has unique IDs for each issue
- [ ] Remediation guide has actionable fix patterns
- [ ] Cross-references between inventory and remediation guide
- [ ] Priority order for fixing documented

 **Deliverables:**
  - [ ] internalDoc/CODE_QUALITY_ISSUES.md created (100+ lines)
  - [ ] internalDoc/CODE_QUALITY_REMEDIATION.md created (50+ lines)
  - [ ] Summary statistics documented
</verification>

<success_criteria>
- Complete grep inventory of all 44 source files
- All 39 flagged issues categorized by severity
- Issue inventory with file locations and line numbers
- Recommended remediation approaches documented
- Ready for Phase 32: Linting & Audit Execution
</success_criteria>

<output>
After completion, create `.planning/phases/31-linting-audit/31-03-SUMMARY.md` with:
- Final issue inventory statistics (internalDoc/CODE_QUALITY_ISSUES.md)
- Remediation priorities (internalDoc/CODE_QUALITY_REMEDIATION.md)
- Ready-to-execute action items for Phase 32
