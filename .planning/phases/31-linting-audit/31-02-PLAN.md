---
phase: 31-linting-audit
plan: "02"
type: execute
wave: 2
depends_on:
  - "31-01"
files_modified:
  - Cargo.toml
  - .cargo/config
  - .planning/phases/31-linting-audit/geiger-report.md
autonomous: true
user_setup: []
must_haves:
  truths:
    - "cargo-geiger is installed and functional"
    - "Baseline unsafe code scan completed on all source files"
    - "All unsafe usage locations are documented with line numbers"
  artifacts:
    - path: ".planning/phases/31-linting-audit/geiger-report.md"
      provides: "Baseline unsafe code inventory"
      min_lines: 50
    - path: "Cargo.toml"
      provides: "geiger configuration for ongoing tracking"
      contains: "[lints.rust]"
    - path: ".cargo/config"
      provides: "Geiger toolchain configuration"
      contains: "geiger"
  key_links:
    - from: "geiger-report.md"
      to: "src/ files"
      via: "cargo geiger --all-targets"
      pattern: "geiger-report tracks unsafe usage locations"
---

<objective>
Install and configure cargo-geiger to track unsafe Rust usage across the codebase, creating a baseline inventory of all unsafe code blocks.
</objective>

<execution_context>
@/home/juan/.config/opencode/get-shit-done/workflows/execute-plan.md
@/home/juan/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/research/code-quality-rust-RESEARCH.md
@.planning/phases/31-linting-audit/31-01-SUMMARY.md

**Unsafe Code Tracking:**
- cargo-geiger detects unsafe {} blocks and unsafe functions
- Tracks unsafe trait implementations, methods, casts, functions
- Counts lines containing unsafe code
- Provides percentage of unsafe code per file

**Why This Matters:**
- Embedded systems: unsafe in hardware access is necessary but must be minimized
- Each unsafe block is a potential unsoundness vulnerability
- Required for embassy-rs and ESP32-C3 peripheral access

**Codebase Expectations:**
- 39 occurrences flagged (likely mix of unwrap/panic and unsafe)
- Hardware files (ssr.rs, adc.rs, gpio.rs) likely have legitimate unsafe code
</context>

<tasks>

<task type="auto">
  <name>Install cargo-geiger and run baseline scan</name>
  <files>Cargo.toml</files>
  <action>
    Install and configure cargo-geiger:

    1. cargo install cargo-geiger
    2. Run cargo geiger --all-targets --output-format markdown
    3. Save output to .planning/phases/31-linting-audit/geiger-raw.md

    This provides a comprehensive inventory of all unsafe usage across the codebase.
  </action>
  <verify>
    cargo geiger --all-targets 2>&1 | head -100
  </verify>
  <verify_after>
    cargo geiger --all-targets 2>&1 | grep -c "unsafe" || echo "0"
  </verify_after>
  <done>
    cargo-geiger installed and baseline scan completed
  </done>
</task>

<task type="auto">
  <name>Create formatted geiger report with file inventory</name>
  <files>.planning/phases/31-linting-audit/geiger-report.md</files>
  <action>
    Create a formatted geiger-report.md that includes:

    1. Executive summary: Total unsafe blocks, percentage of codebase
    2. Breakdown by file (sorted by unsafe count descending):
       - File path
       - Number of unsafe blocks
       - Line numbers where unsafe appears
       - Brief description of what each unsafe block does
    3. Categorization:
       - Hardware access (ADC, GPIO, SPI, I2C)
       - FFI/foreign function calls
       - Embedded-hal implementations
       - Other
    4. Risk assessment for each unsafe block

    Reference the 44 source files mentioned in research. Extract line numbers from geiger output.
  </action>
  <verify>
    cat .planning/phases/31-linting-audit/geiger-report.md | head -80
  </verify>
  <verify_after>
    grep -c "^### " .planning/phases/31-linting-audit/geiger-report.md || echo "0"
  </verify_after>
  <done>
    Formatted geiger report exists with all unsafe locations documented
  </done>
</task>

<task type="auto">
  <name>Configure geiger for ongoing tracking</name>
  <files>.cargo/config</files>
  <action>
    Configure cargo-geiger for ongoing tracking in CI/CD:

    1. Create .cargo/config with geiger alias:
       ```
       [alias]
       geiger = "geiger --all-targets --output-format markdown"
       ```
    2. Optionally add to Cargo.toml lints.rust section if geiger supports it
    3. Document in README how to run: "Run `cargo geiger` to check unsafe code"

    This ensures unsafe code tracking continues throughout development.
  </action>
  <verify>
    cat .cargo/config
  </verify>
  <verify_after>
    grep -q "geiger" .cargo/config && echo "geiger configured" || echo "not configured"
  </verify_after>
  <done>
    cargo-geiger configured for ongoing use with alias and documentation
  </done>
</task>

</tasks>

<verification>
**Installation Verification:**
- [ ] cargo geiger --version outputs version info
- [ ] cargo geiger --all-targets completes without errors
- [ ] geiger-report.md exists with all unsafe blocks documented

**Report Quality:**
- [ ] All 44 source files scanned
- [ ] Each unsafe block has line number and description
- [ ] Categorization covers hardware access, FFI, embedded-hal
- [ ] Risk assessment provided for each block

**Ongoing Tracking:**
- [ ] .cargo/config has geiger alias
- [ ] Documented in project documentation
</verification>

<success_criteria>
- cargo-geiger installed and functional
- Baseline unsafe code inventory created
- All unsafe locations documented with line numbers
- Ongoing tracking configured for future development
</success_criteria>

<output>
After completion, create `.planning/phases/31-linting-audit/31-02-SUMMARY.md` with:
- Geiger scan results summary
- All unsafe code locations documented
- Configuration decisions
