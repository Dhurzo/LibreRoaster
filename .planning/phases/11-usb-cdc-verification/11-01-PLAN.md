---
phase: "11-usb-cdc-verification"
plan: "01"
type: "execute"
wave: 1
depends_on: []
files_modified:
  - "src/input/multiplexer.rs"
  - "src/hardware/usb_cdc/driver.rs"
  - "src/hardware/usb_cdc/tasks.rs"
autonomous: true
user_setup: []

must_haves:
  truths:
    - "Multiplexer correctly activates channel on first command"
    - "Multiplexer ignores commands on inactive channel"
    - "Multiplexer resets channel after 60-second timeout"
    - "USB driver initializes without errors on ESP32-C3"
    - "Commands received via USB are parsed correctly"
    - "Error responses are routed to correct channel"
  artifacts:
    - path: "src/input/multiplexer.rs"
      provides: "Channel activation, timeout, and ignore logic"
      min_lines: 50
    - path: "src/hardware/usb_cdc/tasks.rs"
      provides: "Command processing and error routing"
      min_lines: 40
    - path: "tests/multiplexer_tests.rs"
      provides: "Unit tests for multiplexer logic"
      exports: ["test_multiplexer_channel_activation", "test_multiplexer_timeout", "test_multiplexer_ignore_inactive"]
    - path: "tests/mock_usb_driver.rs"
      provides: "Hardware mock for USB CDC driver"
      exports: ["MockUsbCdcDriver"]
  key_links:
    - from: "src/input/multiplexer.rs"
      to: "src/hardware/usb_cdc/tasks.rs"
      via: "should_process_command() call"
      pattern: "should_process_command"
    - from: "src/hardware/usb_cdc/tasks.rs"
      to: "src/input/parser.rs"
      via: "parse_artisan_command()"
      pattern: "parse_artisan_command"
    - from: "tests/multiplexer_tests.rs"
      to: "src/input/multiplexer.rs"
      via: "CommandMultiplexer struct"
      pattern: "CommandMultiplexer"
---

<objective>
Create comprehensive unit tests for the USB CDC driver and multiplexer logic, verifying channel switching behavior, timeout handling, and command routing.

Purpose: Ensure the multiplexer correctly implements the first-command-wins pattern, 60-second idle timeout, and channel isolation before hardware testing.
Output: Working unit tests for multiplexer logic and a mock USB driver for testing.
</objective>

<execution_context>
@/home/juan/.config/opencode/get-shit-done/workflows/execute-plan.md
@/home/juan/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/phases/11-usb-cdc-verification/CONTEXT.md
@.planning/codebase/TESTING.md

# Key multiplexer behaviors from implementation:
# - First command received activates channel
# - Commands on inactive channel are ignored (return false)
# - 60-second idle timeout resets channel to None
# - should_write_to() returns true only for active channel
</context>

<tasks>

<task type="auto">
  <name>Create multiplexer unit tests</name>
  <files>tests/multiplexer_tests.rs</files>
  <action>
    Create `tests/multiplexer_tests.rs` with comprehensive tests for CommandMultiplexer:

    **Test cases to implement:**

    1. **test_multiplexer_channel_activation_none_to_usb**:
       - Create CommandMultiplexer with default state (channel = None)
       - Call on_command_received(CommChannel::Usb)
       - Verify: active_channel == CommChannel::Usb, returns true

    2. **test_multiplexer_channel_activation_none_to_uart**:
       - Create CommandMultiplexer with default state
       - Call on_command_received(CommChannel::Uart)
       - Verify: active_channel == CommChannel::Uart, returns true

    3. **test_multiplexer_ignore_inactive_channel**:
       - Set multiplexer to Usb channel
       - Call on_command_received(CommChannel::Uart)
       - Verify: returns false, active_channel remains Usb, info! log called

    4. **test_multiplexer_same_channel_allowed**:
       - Set multiplexer to Usb channel
       - Call on_command_received(CommChannel::Usb) again
       - Verify: returns true, active_channel remains Usb

    5. **test_multiplexer_timeout_reset**:
       - Simulate time passage (embassy_time::Instant manipulation)
       - Set multiplexer to Usb, let timeout expire
       - Call on_command_received(CommChannel::Uart)
       - Verify: returns true, active_channel switches to Uart

    6. **test_should_write_to_active_channel**:
       - Set multiplexer to Usb
       - Verify: should_write_to(Usb) == true, should_write_to(Uart) == false

    7. **test_should_write_to_none_channel**:
       - Keep multiplexer at None (initial state)
       - Verify: should_write_to(Usb) == false, should_write_to(Uart) == false

    8. **test_multiplexer_reset**:
       - Set multiplexer to Usb, then call reset()
       - Verify: active_channel == CommChannel::None

    9. **test_is_idle_with_no_commands**:
       - Create fresh multiplexer (no commands received)
       - Verify: is_idle() == true

    10. **test_is_idle_after_commands**:
        - Set multiplexer to Usb
        - Verify: is_idle() == false (recent command)
  </action>
  <verify>
    Run `cargo test multiplexer` and verify all 10 tests pass
  </verify>
  <done>
    All multiplexer unit tests pass, verifying channel activation, timeout, and isolation behavior
  </done>
</task>

<task type="auto">
  <name>Create hardware mock for USB CDC driver</name>
  <files>tests/mock_usb_driver.rs</files>
  <action>
    Create `tests/mock_usb_driver.rs` for testing USB CDC operations without hardware:

    **MockUsbCdcDriver struct:**
    ```rust
    pub struct MockUsbCdcDriver {
        connected: bool,
        read_buffer: Vec<u8>,
        write_buffer: Vec<u8>,
        read_errors: usize,
        write_errors: usize,
    }
    ```

    **Implementation requirements:**
    - `new()`: Initialize with connected=true, empty buffers
    - `write_bytes()`: Append data to write_buffer, return Ok(())
    - `read_bytes()`: Pop from read_buffer, return count
    - `is_connected()`: Return connected state
    - `set_connected()`: Toggle connection state
    - `queue_read_data()`: Add bytes to read_buffer for testing
    - `get_written_data()`: Extract and clear write_buffer
    - `get_read_errors()`: Return error count
    - `get_write_errors()`: Return error count

    **For embedded-hal compatibility:**
    - Implement `embedded_io::Read` if needed for testing
    - Keep it simple - this is a test double, not a full mock
  </action>
  <verify>
    Run `cargo test --lib mock_usb_driver` and verify compilation
  </verify>
  <done>
    MockUsbCdcDriver struct ready for use in USB CDC tests
  </done>
</task>

<task type="auto">
  <name>Create USB command processing tests</name>
  <files>tests/usb_cdc_tests.rs</files>
  <action>
    Create `tests/usb_cdc_tests.rs` testing USB command processing:

    **Test cases:**

    1. **test_process_complete_usb_command**:
       - Queue "READ\r" to mock driver
       - Call process_usb_command_data with queued bytes
       - Verify: command parsed successfully, routed to artisan channel

    2. **test_process_empty_command**:
       - Queue just "\r" (CR without data)
       - Call process_usb_command_data
       - Verify: ParseError::EmptyCommand returned

    3. **test_process_invalid_command**:
       - Queue "BOGUS\r"
       - Call process_usb_command_data
       - Verify: ParseError::InvalidCommand returned

    4. **test_process_ot1_command**:
       - Queue "OT1 75\r"
       - Call process_usb_command_data
       - Verify: SetHeater(75) command produced

    5. **test_process_io3_command**:
       - Queue "IO3 50\r"
       - Call process_usb_command_data
       - Verify: SetFan(50) command produced

    6. **test_buffer_overflow_handling**:
       - Queue command exceeding 64-byte buffer
       - Call process_usb_command_data
       - Verify: ParseError::InvalidValue returned

    7. **test_command_routed_to_correct_channel**:
       - Set multiplexer to Usb channel
       - Queue valid command
       - Verify: should_process_command(Usb) returns true
       - Verify: command sent to artisan channel

    8. **test_command_ignored_on_inactive_channel**:
       - Set multiplexer to Uart channel (not Usb)
       - Queue valid command
       - Verify: should_process_command(Usb) returns false
       - Verify: command NOT sent to artisan channel

    9. **test_error_routed_to_correct_channel**:
       - Set multiplexer to Usb
       - Queue invalid command
       - Verify: error message written to output channel

    10. **test_error_ignored_on_inactive_channel**:
        - Set multiplexer to Uart
        - Queue invalid command
        - Verify: error message NOT written to output channel
  </action>
  <verify>
    Run `cargo test usb_cdc` and verify all 10 tests pass
  </verify>
  <done>
    USB CDC command processing tests verify parsing, routing, and error handling
  </done>
</task>

</tasks>

<verification>
After Plan 11-01 completes, run full test suite:
```bash
cargo test --lib
cargo test multiplexer
cargo test usb_cdc
```

Expected: All tests pass, no warnings about unused functions or fields.
</verification>

<success_criteria>
- [ ] 20+ unit tests created (10 multiplexer + 10 USB CDC)
- [ ] MockUsbCdcDriver struct implemented
- [ ] All tests pass without hardware
- [ ] Channel switching logic verified
- [ ] Timeout behavior verified
- [ ] Command routing verified
- [ ] Error handling verified
</success_criteria>

<output>
After completion, create `.planning/phases/11-usb-cdc-verification/11-01-SUMMARY.md`
</output>
