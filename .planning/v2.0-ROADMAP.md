# Milestone v2.0: Code Quality & Best Practices

**Status:** ðŸ“‹ PLANNED
**Phases:** 31-37
**Total Plans:** 17

## Overview

Comprehensive code quality audit and refactoring to eliminate code smells, bad practices, and technical debt from LibreRoaster's ESP32-C3 firmware. This milestone addresses 39 flagged unwrap/panic/unsafe issues, implements proper error handling patterns, and establishes quality gates to prevent future regressions. All functionality must be preserved with zero regression allowed.

## Phases

### Phase 31: Linting & Audit Foundation

**Goal:** Establish tooling baseline by configuring cargo-clippy, cargo-geiger, and running comprehensive audit on all 44 source files.
**Depends on:** â€”
**Plans:** 3 plans

Plans:

- [ ] 31-01: Configure cargo-clippy with embedded-specific lint rules
- [ ] 31-02: Install and configure cargo-geiger for unsafe code tracking
- [ ] 31-03: Run baseline audit and document all 39 flagged issues with severity

**Details:**
Configure clippy.toml to disallow unwrap_used, expect_used, and panic in production code. Install cargo-geiger to track unsafe Rust usage across the codebase. Run comprehensive grep inventory on all 44 files to categorize unwrap(), panic!, and unsafe usages. Create issue inventory spreadsheet with file locations, severity classification (Critical/High/Medium/Low), and recommended remediation approach.

---

### Phase 32: Error Handling Standardization

**Goal:** Replace any non-thiserror error patterns with centralized thiserror-based error types and propagate Result types throughout codebase.
**Depends on:** Phase 31
**Plans:** 3 plans

Plans:

- [ ] 32-01: Audit existing error types in src/error/ and identify non-thiserror patterns
- [ ] 32-02: Migrate all error types to thiserror v2.0+ with no_std support
- [ ] 32-03: Add proper error propagation (? operator) across all modules

**Details:**
Review existing error handling patterns. Replace anyhow usage with thiserror (anyhow requires std, unsuitable for embedded). Create centralized RoasterError enum with variants for UART, parser, sensor, and state machine errors. Implement From traits for HAL errors. Add Error state transitions in the main state machine to handle errors gracefully instead of panicking.

---

### Phase 33: Unwrap Elimination - Critical Paths

**Goal:** Eliminate all unwrap() calls from async task code and HAL interactions that could cause executor crashes.
**Depends on:** Phase 32
**Plans:** 4 plans

Plans:

- [ ] 33-01: Audit all unwrap() calls in src/control/roaster_refactored.rs (476 lines)
- [ ] 33-02: Audit unwrap() calls in src/control/handlers.rs (463 lines)
- [ ] 33-03: Audit unwrap() calls in src/output/artisan.rs (453 lines) and src/input/parser.rs (388 lines)
- [ ] 33-04: Replace all critical path unwrap() with proper Result handling and error propagation

**Details:**
Critical priority: unwrap() in async tasks can crash the entire embassy executor. Replace with ? operator and RoasterError propagation. For HAL calls that return nb::Error, convert to RoasterError at the trait boundary. For Option types in task code, handle None case explicitly with state transitions to Error state. Preserve all functionality by ensuring error cases are handled, not just the happy path.

---

### Phase 34: Unwrap & Panic Remediation - Other Paths

**Goal:** Address remaining unwrap() calls and replace panic!() invocations with graceful error handling.
**Depends on:** Phase 33
**Plans:** 3 plans

Plans:

- [ ] 34-01: Review and fix unwrap() calls in hardware/ssr.rs (354 lines)
- [ ] 34-02: Replace panic!() calls with error logging and state machine transitions
- [ ] 34-03: Configure proper panic handlers and verify graceful degradation paths

**Details:**
Medium priority: unwrap() in initialization code. Document why each case shouldn't happen in production and add comments. Replace panic!() with defmt::error!() logging and transition to safe error state. Ensure SSR outputs enter safe state on errors. Verify panic handler outputs useful debug information for field troubleshooting.

---

### Phase 35: Code Smell Cleanup

**Goal:** Refactor long functions, eliminate duplication, improve naming, and reduce file complexity.
**Depends on:** Phase 31
**Plans:** 2 plans

Plans:

- [ ] 35-01: Refactor roaster_refactored.rs (476 lines) - extract helper functions, reduce cyclomatic complexity
- [ ] 35-02: Run duplication detection, improve naming conventions, eliminate dead code

**Details:**
Target files exceeding 300 lines for refactoring. Extract pure functions for testability. Reduce function complexity by breaking into smaller units. Use clippy's cyclomatic_complexity lint as guide. Run cargo-deadlinks to find unused dependencies. Rename variables for clarity (e.g., single-letter names to descriptive names). Extract common parsing logic in src/input/parser.rs into reusable functions.

---

### Phase 36: Test Coverage Expansion

**Goal:** Add unit tests for error paths, increase integration test coverage using embedded-hal-mock patterns.
**Depends on:** Phase 32
**Plans:** 1 plan

Plans:

- [ ] 36-01: Expand test coverage for error paths using embedded-hal-mock UART patterns

**Details:**
Add unit tests for all new error handling paths. Create mock UART implementation using embedded-hal-mock patterns for src/input/parser.rs testing. Add tests for checksum validation, timeout handling, and malformed frame rejection. Increase coverage in artisan protocol parsing. Verify existing integration tests (tests/artisan_integration_test.rs, tests/command_errors.rs) still pass.

---

### Phase 37: Final Verification & Quality Gates

**Goal:** Run full test suite, verify no regression, configure CI quality gates, and document quality status.
**Depends on:** Phase 34, Phase 35, Phase 36
**Plans:** 1 plan

Plans:

- [ ] 37-01: Final verification - run all tests, clippy, geiger, and update README with quality status

**Details:**
Run full test suite: unit tests, integration tests, and hardware validation. Execute cargo clippy with new configuration - verify zero warnings for disallow rules. Run cargo-geiger - ensure all unsafe code has safety documentation. Update README.md with code quality status, testing coverage, and linting configuration. Create .clippy.toml and .cargo/config.toml for CI quality gates.

---

## Milestone Summary

**Phases:** 7 (31-37)
**Plans:** 17
**Tasks:** ~45-60 subtasks estimated
**Duration:** 3-4 weeks

**Key Objectives:**
- Eliminate all 39 flagged unwrap/panic/unsafe issues
- Implement thiserror-based centralized error handling
- Configure cargo-clippy with embedded-specific rules
- Achieve zero clippy warnings with disallow rules
- Expand test coverage for error paths
- Establish CI quality gates preventing future regressions

**Quality Gates:**
- All unit tests pass
- All integration tests pass (artisan_integration_test.rs, command_errors.rs, command_idempotence.rs)
- cargo clippy reports zero warnings with configured disallow rules
- cargo-geiger shows all unsafe code documented with safety comments
- No unwrap() or panic!() remains in production async task code

**Technical Approach:**
- Phase 31-33 establish foundation and fix critical paths first
- Phase 34-35 address remaining issues and code smells
- Phase 36-37 verify quality and prevent regressions
- Zero regression allowed - each plan must verify functionality preserved

**Research Applied:**
- thiserror v2.0+ for no_std error handling (from .planning/research/code-quality-rust-RESEARCH.md)
- cargo-clippy with disallow rules for unwrap/panic prevention
- cargo-geiger for unsafe code tracking
- embedded-hal-mock for peripheral testing patterns
- embassy-futures error propagation for async task boundaries

**Risk Mitigation:**
- Each refactoring plan includes verification step
- Error handling changes are additive before removing old patterns
- Integration tests catch regressions early
- Hardware testing validates SSR safe state behavior

---

_Planned: 2026-02-05 as part of v2.0 Code Quality & Best Practices milestone_
